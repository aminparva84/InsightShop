# Deploy InsightShop to AWS App Runner on push to main
# Prerequisites: Run scripts/setup-apprunner.ps1 once and add GitHub secrets (see script output).

name: Deploy to AWS App Runner 

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPO_NAME: insightshop
  APP_RUNNER_SERVICE_NAME: insightshop

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPO_NAME:latest .
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:latest
          echo "image=$ECR_REGISTRY/$ECR_REPO_NAME:latest" >> $GITHUB_OUTPUT

      - name: Get or create App Runner service
        id: apprunner
        env:
          IMAGE_URI: ${{ steps.build.outputs.image }}
          ACCESS_ROLE_ARN: ${{ secrets.APP_RUNNER_ACCESS_ROLE_ARN }}
          INSTANCE_ROLE_ARN: ${{ secrets.APP_RUNNER_INSTANCE_ROLE_ARN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          set -e
          # App requires JWT_SECRET (>=32 chars) when FLASK_ENV=production; use default if secret not set so service can start.
          if [ -z "$JWT_SECRET" ] || [ ${#JWT_SECRET} -lt 32 ]; then
            export JWT_SECRET="InsightShop-AppRunner-Default-ChangeInConsole32"
          fi
          SERVICE_ARN=$(aws apprunner list-services --region $AWS_REGION --query "ServiceSummaryList[?ServiceName=='$APP_RUNNER_SERVICE_NAME'].ServiceArn" --output text)
          CREATED="false"
          if [ -z "$SERVICE_ARN" ] || [ "$SERVICE_ARN" == "None" ]; then
            echo "Creating App Runner service..."
            # Option A: JSON payload with SourceConfiguration.AuthenticationConfiguration (ECR access role) as sibling of ImageRepository, per API.
            python3 << 'PYEOF'
          import json, os
          # SourceConfiguration: AuthenticationConfiguration and ImageRepository are siblings (API shape).
          # ImageRepository must contain only ImageIdentifier, ImageConfiguration, ImageRepositoryType.
          # JWT_SECRET is required by app in production (config.py); without it the app crashes at startup -> CREATE_FAILED.
          runtime_vars = {"FLASK_ENV": "production", "PYTHONUNBUFFERED": "1", "JWT_SECRET": os.environ.get("JWT_SECRET", "InsightShop-AppRunner-Default-ChangeInConsole32")}
          source_config = {
            "AuthenticationConfiguration": {"AccessRoleArn": os.environ["ACCESS_ROLE_ARN"]},
            "AutoDeploymentsEnabled": False,
            "ImageRepository": {
              "ImageIdentifier": os.environ["IMAGE_URI"],
              "ImageRepositoryType": "ECR",
              "ImageConfiguration": {
                "Port": "5000",
                "RuntimeEnvironmentVariables": runtime_vars
              }
            }
          }
          inst_cfg = {}
          if os.environ.get("INSTANCE_ROLE_ARN"):
            inst_cfg["InstanceRoleArn"] = os.environ["INSTANCE_ROLE_ARN"]
          req = {
            "ServiceName": os.environ["APP_RUNNER_SERVICE_NAME"],
            "SourceConfiguration": source_config,
            "InstanceConfiguration": inst_cfg,
            "HealthCheckConfiguration": {"Protocol": "HTTP", "Path": "/api/health", "Interval": 10, "Timeout": 5, "HealthyThreshold": 1, "UnhealthyThreshold": 5}
          }
          with open("create-service-input.json", "w") as f:
            json.dump(req, f, indent=2, sort_keys=False)
          PYEOF
            SERVICE_ARN=$(aws apprunner create-service --region $AWS_REGION --cli-input-json file://create-service-input.json --query 'Service.ServiceArn' --output text)
            echo "Service created: $SERVICE_ARN"
            CREATED="true"
          else
            echo "Service exists: $SERVICE_ARN"
          fi
          echo "service_arn=$SERVICE_ARN" >> $GITHUB_OUTPUT
          echo "created=$CREATED" >> $GITHUB_OUTPUT

      # App Runner can stay OPERATION_IN_PROGRESS for 3-5+ min (image pull, start, health checks). Wait up to 6 min.
      - name: Wait for service RUNNING (before triggering deployment)
        if: steps.apprunner.outputs.created != 'true'
        run: |
          echo "Waiting for service to be in RUNNING state (up to 6 minutes)..."
          for i in $(seq 1 36); do
            STATUS=$(aws apprunner describe-service --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --query 'Service.Status' --output text)
            echo "Service status: $STATUS (poll $i/36)"
            if [ "$STATUS" = "RUNNING" ]; then
              echo "Service is RUNNING."
              exit 0
            fi
            if [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "DELETE_FAILED" ]; then
              echo "::error::Service is in $STATUS state. Deleting so next run can recreate."
              aws apprunner delete-service --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --output text --query 'Service.Status' || true
              exit 1
            fi
            if [ "$STATUS" = "UPDATE_FAILED" ]; then
              echo "::error::Service is in UPDATE_FAILED state. Check AWS Console (App Runner → insightshop) for health check or deployment logs."
              aws apprunner list-operations --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --max-results 3 --output table 2>/dev/null || true
              exit 1
            fi
            # Fail fast if latest operation is FAILED (deployment failed)
            OP_STATUS=$(aws apprunner list-operations --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --max-results 1 --query 'OperationSummaryList[0].Status' --output text 2>/dev/null || echo "Unknown")
            if [ "$OP_STATUS" = "FAILED" ] || [ "$OP_STATUS" = "ROLLBACK_FAILED" ]; then
              echo "::error::Latest operation status: $OP_STATUS. Check App Runner service in AWS Console for details."
              aws apprunner list-operations --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --max-results 3 --output table 2>/dev/null || true
              exit 1
            fi
            sleep 10
          done
          echo "::error::Timeout waiting for service to reach RUNNING state (6 min). Service may be stuck in OPERATION_IN_PROGRESS; check AWS Console."
          exit 1

      - name: Ensure service is RUNNING
        if: steps.apprunner.outputs.created != 'true'
        run: |
          STATUS=$(aws apprunner describe-service --region $AWS_REGION --service-arn "${{ steps.apprunner.outputs.service_arn }}" --query 'Service.Status' --output text)
          if [ "$STATUS" != "RUNNING" ]; then
            echo "::error::Service is not in RUNNING state; status: $STATUS. Resolve in AWS Console (App Runner → insightshop) or check health check config."
            exit 1
          fi
          echo "Service status: RUNNING."

      - name: Trigger App Runner deployment
        if: steps.apprunner.outputs.created != 'true'
        run: |
          aws apprunner start-deployment \
            --region $AWS_REGION \
            --service-arn "${{ steps.apprunner.outputs.service_arn }}"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          aws apprunner wait deployment-successful \
            --region $AWS_REGION \
            --service-arn "${{ steps.apprunner.outputs.service_arn }}"
          echo "Deployment completed successfully."

      - name: Output service URL
        run: |
          SERVICE_URL=$(aws apprunner describe-service \
            --region $AWS_REGION \
            --service-arn "${{ steps.apprunner.outputs.service_arn }}" \
            --query 'Service.ServiceUrl' --output text)
          echo "::notice title=InsightShop deployed::Service URL: https://$SERVICE_URL"

